<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>St. Jude Cloud Upload</title>
	<link rel="stylesheet" href="../../bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="../../todc-bootstrap/dist/css/todc-bootstrap.min.css">
	<style>
		.container {
			position: absolute;
			top: 50%;
			left: 50%;
			margin-right: -50%;
			transform: translate(-50%, -50%)
		}

		form {
			color: white;
			border: 4pt dashed #000;
			width: 300px;
			height: 300px;
		}

		form p {
			width: 100%;
			height: 100%;
			text-align: center;
			line-height: 170px;
			color: #000;
		}
	</style>
</head>

<body>
	<div id="static-message" class="container">
		<form id="file-upload-form" class="form-horizontal">
			<div class="form-group">
				<p>Drag your files in the box or click here!</p>
			</div>
		</form>
		<div class="col-md-4 col-md-offset-3">
			<ul id="files-list"></ul>
			<select id="project-list" class="form-control" style="margin-top:10px;"></select>
			<button id="upload-btn" class="btn btn-primary btn-large" style="margin-top:10px;" disabled>Upload</button>
		</div>
	</div>
	<div id="dynamic-message" style="display: none;">
		<div id="upload-message"></div>
		<div class="progress">
            <div id="progress-bar" class="progress-bar active"></div>
        </div>
		<div>
			<button id="project-btn" class="btn btn-primary btn-lrg">Go to Project</button>
			<button id="reset-btn" class="btn btn-danger btn-lrg">Reset</button>
		</div>
	</div>
</body>
<script>
	window.jQuery = window.$ = require('jquery');

</script>
<script src="../../bootstrap/dist/js/bootstrap.min.js"></script>
<script>
	$(function () {
		const dx = require("../../../src/dx");
		const sjutils = require("../../../src/utils");
		const { shell, remote } = require('electron');
		const { dialog } = require("electron").remote;
		const async = require("async");

		/**
		 * Grab projects first.
		 **/

		dx.listProjects(function (err, results) {
			if (err) {
				console.error(err);
				document.write("Could not get projects.");
				return;
			}
			let project_select = document.getElementById("project-list");
			results.forEach(function (elem) {
				var option = document.createElement("option");
				option.text = elem["project_name"];
				option.value = elem["dx_location"];
				project_select.add(option);
			});
		});

		/**
		 * Next, setup handlers.
		 **/

		function updateFilesList(files) {

			$("#files-list").empty();

			if (!files || files.length <= 0) {
				$('#upload-btn').prop('disabled', true);
				return;
			} else {
				$('#upload-btn').prop('disabled', false);
			}

			files.forEach(function (elem) {
				$("#files-list").append("<li>" + elem + "</li>");
			});
		}

		$("#file-upload-form").click(function () {
			dialog.showOpenDialog(
				{ properties: ["openFile", "multiSelections"] },
				function (files) { return updateFilesList(files); }
			);
		});

		var holder = document.getElementById('file-upload-form');
		holder.ondragover = () => {
			return false;
		};
		holder.ondragleave = () => {
			return false;
		};
		holder.ondragend = () => {
			return false;
		};
		holder.ondrop = (e) => {
			e.preventDefault();
			var files = [];
			for (let f of e.dataTransfer.files) {
				files.append(f);
			}
			updateFilesList(files);
			return false;
		};

		function performUpload() {
			let projectName = $("#project-list").find(":selected").text();
			var tasks = [];
			const children = $("#files-list").children()
			console.error("Children: "+children.length.toString())
			children.each(function (index, element) {
				let fileName = $(this).text();
				tasks.push(function (next) {
					updateProgress(Math.round(100.0 * index / children.length).toString() + "%", "Uploading " + fileName + " to " + projectName + "...")
					dx.uploadFile(fileName, projectName, function (err, result) {
						next(err, result);
					});
				});
			});

			async.series(tasks, function (err, result) {
				if (err) {
					console.error("An error occurred!");
					return;
				}

				updateProgress("100%", "Successfully uploaded all files!");
			});
		}

		$("#upload-btn").click(function (event) {
			event.preventDefault();
			$("#static-message").hide();
			$("#dynamic-message").show();
			$('#project-btn').on('click', function () {
				let dxLocation = $("#project-list").find(":selected").val().replace("project-", "");
				console.log(dxLocation);
				shell.openExternal("https://platform.dnanexus.com/projects/"+dxLocation+"/data/")
			});
			performUpload();
		});

		$('#reset-btn').click(function(event) {
			event.preventDefault();
			$("#static-message").show();
			$("#dynamic-message").hide();
			updateProgress("0%", "");
			updateFilesList(undefined);
		});

		function updateProgress(val, message) {
			console.log(val, message);
			$('#upload-message').text(message);
            $('#progress-bar').width(val);
            if (val == '100%')
                $('#progress-bar').addClass("progress-bar-success");
        }

        function failProgress(failmessage) {
			$('#upload-message').text(failmessage);
            $('#progress-bar').addClass("progress-bar-danger").width("100%");
        }

	});

</script>

</html>