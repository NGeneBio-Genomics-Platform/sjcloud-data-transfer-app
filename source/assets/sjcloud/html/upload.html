<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>St. Jude Cloud Upload</title>
  <link rel="stylesheet" href="../../../../node_modules/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../../../node_modules/todc-bootstrap/dist/css/todc-bootstrap.min.css">
  <style>
    .container {
      position: absolute;
      top: 50%;
      left: 50%;
      margin-right: -50%;
      transform: translate(-50%, -50%)
    }

    #drag-n-drop {
      color: white;
      border: 4pt dashed #000;
      width: 300px;
      height: 300px;
    }

    #drag-n-drop p {
      width: 100%;
      height: 100%;
      text-align: center;
      line-height: 170px;
      color: #000;
    }
  </style>
</head>

<body>
  <div id="static-message" class="container">
    <form id="file-upload-form" class="form-horizontal">
      <div id="drag-n-drop" class="form-group">
        <p>Drag your files in the box or click here.</p>
      </div>

      <div class="col-md-6 col-md-offset-3">
        <div id="form-group">
          <ul id="files-list"></ul>
        </div>
        <div id="form-group">
          <label for="project-list">Project List</label>
          <select id="project-list" class="form-control" style="margin-top:10px;"></select>
        </div>
        <div id="form-group">
          <label for="upload-type">Upload Type</label>
          <select class="form-control" id="upload-type">
            <option value="parallel">Upload files in parallel</option>
            <option value="series">Upload files sequentially</option>
          </select>
        </div>
        <div id="form-group">
          <button id="upload-btn" class="btn btn-primary btn-large" style="margin-top:10px;" disabled>Upload</button>
          <button id="reset-btn-one" class="btn btn-danger btn-large" style="margin-top:10px;" disabled>Reset</button>
        </div>
      </div>
    </form>
  </div>
  <div id="dynamic-message" class="container" style="display: none;">
    <table id="progress-table" class="table">
      <thead>
        <tr>
          <th>File</th>
          <th>DNAnexus Project</th>
          <th>Status</th>
          <th>Progress</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <div id="upload-message"></div>
    <div class="progress">
      <div id="progress-bar" class="progress-bar active"></div>
    </div>
    <div>
      <button id="project-btn" class="btn btn-primary btn-lrg">Go to Project</button>
      <button id="reset-btn-two" class="btn btn-danger btn-lrg">Reset</button>
    </div>
  </div>
</body>
<script>
  window.jQuery = window.$ = require('jquery');
</script>
<script src="../../../../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
<script>
  $( () => {
    const os = require("os");
    const path = require("path");
    const async = require("async");
    const { shell, remote } = require('electron');
    const { dialog } = require("electron").remote;

    const dx = require("../../../../source/application/dx");
    const sjutils = require("../../../../source/application/utils");

    /**
     * First, grab projects from remote URL.
     **/

    dx.listProjects( (err, results) => {
      if (err) {
        console.error(err);
        document.write("Could not get projects.");
        return;
      }
      let project_select = document.getElementById("project-list");
      if (remote.getGlobal("sjcloudURI") && remote.getGlobal("sjcloudURI")[0] && remote.getGlobal("sjcloudURI")[0].search("sjcloud://") != -1) { // app called by sjcloud:// URI
        var input_project = document.createElement("option");
        input_project.text = remote.getGlobal("sjcloudURI")[0].replace("sjcloud://", "");
        for (i = 1; i < remote.getGlobal("sjcloudURI").length; i++) { // Concatenate project names with spaces
          input_project.text = input_project.text + " " + remote.getGlobal("sjcloudURI")[i];
        }
        input_project.text = input_project.text.substring(0, input_project.text.length - 1); // remove trailing '/'
        var found_project = false;
        results.some( function(elem) {
          if (elem["project_name"] == input_project.text) {
            input_project.value = elem["dx_location"];
            project_select.add(input_project);
            found_project = true;
            results.splice(results.indexOf(elem), 1);
            return true;
          }
        });
        
      }
      if (found_project !== true) {  // app not called by sjcloud:// protocol or linked project was not found
        var default_option = document.createElement("option");
        default_option.text = "Select a project here";
        default_option.value = "invalid";
        project_select.add(default_option);
      };
      results.forEach( (elem) => {
        var option = document.createElement("option");
        option.text = elem["project_name"];
        option.value = elem["dx_location"];
        project_select.add(option);
      });
    });

    /**
     * Next, setup handlers.
     **/
    function checkInput(files) {  // function called when user changes project selection or adds files
      // disable upload button if default menu option is selected
      if ( $("#project-list").find(":selected").val() == "invalid" ) {
        $("#upload-btn").prop("disabled", true);
      }
      // enable upload button if valid project is chosen and files have been selected
      else if (files != null || $("#files-list").children().length != 0 ) {
        $('#upload-btn').prop('disabled', false);
      }
      // update list if new files are being selected
      if (files != null) {
        updateFilesList(files);
      }
      return;
    }
    
    function updateFilesList(files) {
      $("#files-list").empty();

      if (!files || files.length <= 0) {
        $('#upload-btn').prop('disabled', true);
        $('#reset-btn-one').prop("disabled", true);
        
        $('#drag-n-drop').show();
        return;
      } 
      
      $('#reset-btn-one').prop("disabled", false);
      $('#drag-n-drop').hide();
      
      files.forEach( (elem) => {
        $("#files-list").append("<li>" + elem + "</li>");
      });
    }
    $("#project-list").change( () => {
      checkInput(null)
    });
    $("#drag-n-drop").click( () => {
      dialog.showOpenDialog(
        { properties: ["openFile", "multiSelections"] },
         (files) => { return checkInput(files); }
      );
    });

    /**
     * Drag-n-drop
     **/

    var holder = document.getElementById('file-upload-form');

    holder.ondragover = () => {
      return false;
    };

    holder.ondragleave = () => {
      return false;
    };

    holder.ondragend = () => {
      return false;
    };

    holder.ondrop = (e) => {
      e.preventDefault();

      var files = [];
      for (let f of e.dataTransfer.files) {
        files.append(f);
      }
      checkInput(files);
      return false;
    };

    function addProgressTableElement(filename, dxproject, status, progress) {
      const entry = `
      <tr>
        <td>${filename}</td>
        <td>${dxproject}</td>
        <td>${status}</td>
        <td>${progress}</td>
      </tr>
      `;
      $('#progress-table > tbody:last-child').append(entry);
      // return the previously added tr.
      return $('#progress-table tbody tr:last-child')
    }

    function performUpload() {
      let projectName = $("#project-list").find(":selected").val();
      let uploadType = $("#upload-type").find(":selected").val();

      var tasks = [];
      const children = $("#files-list").children()
      children.each( function (index, element) {
        let fileName = $(this).text();
        let fileBaseName = path.basename(fileName);
        addProgressTableElement(fileBaseName, projectName, "Waiting...", "0%");
        tasks.push( (next) => {
          updateProgress(Math.round(100.0 * index / children.length).toString() + "%", "Uploading " + fileName + " to " + projectName + "...")
          let nth = index + 1
          let tableElemTr = $('#progress-table tbody tr:nth-child(' + nth.toString() + ")");
          tableElemTr.children('td:nth-child(3)').text("Uploading...")
          dx.uploadFile(fileName, projectName, (err, result) => {
            tableElemTr.children('td:nth-child(3)').text("Finished.")
            tableElemTr.children('td:nth-child(4)').text("100%")
            next(err, result);
          });
        });
      });

      if(uploadType == "parallel") {
        // Upload in parallel across CPUs.
        var queue = async.queue( (task, cb) => {
          task(cb)
        }, os.cpus().length);

        queue.drain = () => {
          updateProgress("100%", "Successfully uploaded all files!");
        };

        queue.push(tasks);
      } else {
        async.series(tasks, (err, result) => {
          if (err) {
            console.error("An error occurred!");
            failProgress("An error occurred when uploading files!");
            return;
          }

          updateProgress("100%", "Successfully uploaded all files!");
        });
      }
    }

    $("#upload-btn").click( (event) => {
      event.preventDefault();
      $("#static-message").hide();
      $("#dynamic-message").show();
      $('#project-btn').on('click', () => {
        let dxLocation = $("#project-list").find(":selected").val().replace("project-", "");
        shell.openExternal("https://platform.dnanexus.com/projects/" + dxLocation + "/data/uploads")
      });

      performUpload();
    });


    $('#reset-btn-one').click( (event) => {
      event.preventDefault();
      updateFilesList(undefined);
    });

    $('#reset-btn-two').click( (event) => {
      event.preventDefault();
      $("#static-message").show();
      $("#dynamic-message").hide();
      updateProgress("0%", "");
      $('#progress-table tbody').empty();
      updateFilesList(undefined);
    });

    function updateProgress(val, message) {
      console.log(val, message);
      $('#upload-message').text(message);
      $('#progress-bar').width(val);
      if (val == '100%') {
        $('#progress-bar').addClass("progress-bar-success")
      } else {
        $('#progress-bar').removeClass("progress-bar-success")
      }
    }

    function failProgress(failmessage) {
      $('#upload-message').text(failmessage);
      $('#progress-bar').addClass("progress-bar-danger").width("100%");
    }

  });

</script>

</html>
