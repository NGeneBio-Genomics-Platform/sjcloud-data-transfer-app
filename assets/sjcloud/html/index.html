<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>St. Jude Cloud Upload</title>
	<link rel="stylesheet" href="../../bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="../../todc-bootstrap/dist/css/todc-bootstrap.min.css">
	<style>
		.container {
			position: absolute;
			top: 50%;
			left: 50%;
			margin-right: -50%;
			transform: translate(-50%, -50%)
		}

		form {
			color: white;
			border: 4pt dashed #000;
			width: 300px;
			height: 300px;
		}

		form p {
			width: 100%;
			height: 100%;
			text-align: center;
			line-height: 170px;
			color: #000;
		}
	</style>
</head>

<body>
	<div id="static-message" class="container">
		<form id="file-upload-form" class="form-horizontal">
			<div class="form-group">
				<p>Drag your files in the box or click here!</p>
			</div>
		</form>
		<div class="col-md-4 col-md-offset-3">
			<ul id="files-list"></ul>
			<select id="project-list" class="form-control" style="margin-top:10px;"></select>
			<a id="upload-btn" class="btn btn-primary btn-large" style="margin-top:10px;">Upload</a>
		</div>
	</div>
	<div id="dynamic-message" class="container" style="display: none;">
		Uploading!
	</div>
</body>
<script>
	window.jQuery = window.$ = require('jquery');

</script>
<script src="../../bootstrap/dist/js/bootstrap.min.js"></script>
<script>
	$(function () {
		const dx = require("../../../src/dx");
		const sjutils = require("../../../src/utils");
		const { dialog } = require("electron").remote;
		const async = require("async");

		/**
		 * Grab projects first.
		 **/
		dx.listProjects(function (err, results) {
			if (err) {
				console.error(err);
				document.write("Could not get projects.");
				return;
			}
			let project_select = document.getElementById("project-list");
			results.forEach(function (elem) {
				var option = document.createElement("option");
				option.text = elem["project_name"];
				project_select.add(option);
			});
		});

		/**
		 * Next, setup handlers.
		 **/
		$("#file-upload-form").click(function () {
			dialog.showOpenDialog(
				{ properties: ["openFile", "multiSelections"] },
				function (files) {
					$("#files-list").empty();
					files.forEach(function (elem) {
						$("#files-list").append("<li>" + elem + "</li>");
					});
				}
			);
		});

		$("#upload-btn").click(function () {
			$("#static-message").hide();
			$("#dynamic-message").show();
			performUpload();
		});

		var holder = document.getElementById('file-upload-form');
		holder.ondragover = () => {
			return false;
		};
		holder.ondragleave = () => {
			return false;
		};
		holder.ondragend = () => {
			return false;
		};
		holder.ondrop = (e) => {
			e.preventDefault();
			$('#files-list').empty()
			for (let f of e.dataTransfer.files) {
				$('#files-list').append("<li>" + f.path + "</li>")
			}

			return false;
		};

		function performUpload() {
			let projectName = $("#project-list").find(":selected").text();
			var tasks = [];
			$("#files-list").children().each(function () {
				let fileName = $(this).text();
				tasks.push(function (next) {
					$("body").append("Uploading ", fileName, " to ", projectName, ".<br>");
					dx.uploadFile(fileName, projectName, function (err, result) {
						next(err, result);
					});
				});
			});

			async.series(tasks, function (err, result) {
				if (err) {
					console.error("An error occurred!");
					return;
				}

				console.log("Successful!");
			});
		}

	});

</script>

</html>