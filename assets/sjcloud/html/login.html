<html>

<head>
    <link rel="stylesheet" href="../../bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../todc-bootstrap/dist/css/todc-bootstrap.min.css">
    <style>
        .container {
            text-align: center;
            position: absolute;
            top: 40%;
            left: 50%;
            margin-right: -50%;
            transform: translate(-50%, -50%)
        }

        #instructions {
            text-align: left;
        }

        #download-btn-div {
            margin-top: 5%;
        }

        p {
            font-size: 14pt;
            margin-left: 15%;
            margin-right: 15%;
        }

        p#instructions {
            font-size: 11pt;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="static-message">
            <p>
                You do not appear to be logged in! Please follow the steps below.
            </p>
            <hr><br>
            <p id="instructions">
                <b>Step 1. </b> Click on the button below to go to your DNAnexus profile. <br>
                <br>
                <a id="generate-token-btn" class="btn btn-primary btn-lrg" href="https://platform.dnanexus.com/profile/">Go to DNAnexus</a><br>
                <br>
                <b>Step 2. </b> Click "API Tokens". <br>
                <b>Step 3. </b> Click "New Token". Generate a new token. <br>
                <b>Step 4. </b> Paste the generated token in the box below. <br>
            </p>
            <form class="form-horizontal">
                <div class="form-group">
                    <div class="col-xs-6 col-xs-offset-3">
                        <input id="token-input" class="form-control input-lg" type="text">
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-xs-6 col-xs-offset-3">
                        <button id="login-btn" type="button" class="btn btn-primary btn-lg disabled">Login</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="dynamic-message" style="display: none;">
        <div class="progress">
            <div id="progress-bar" class="progress-bar active"></div>
        </div>
    </div>
</body>

<script>
    window.jQuery = window.$ = require('jquery');

</script>
<script src="../../bootstrap/dist/js/bootstrap.min.js"></script>
<script>
    const dx = require('../../../src/dx');
    const utils = require('../../../src/utils');
    const { shell, remote } = require('electron');

    $( () => {

        $('#generate-token-btn').click( function (event) {
            event.preventDefault();
            shell.openExternal(this.href);
        });

        function updateProgress(val, message) {
            $('#progress-bar').width(val).text(message);
            if (val == '100%')
                $('#progress-bar').addClass("progress-bar-success");
        }

        function failProgress(failmessage) {
            $('#progress-bar').addClass("progress-bar-danger").width("100%")
                .text(failmessage);
        }

        /**
         * Handlers
         **/

        $('#login-btn').on('click', function (event) {
            event.preventDefault();
            $('#static-message').hide();
            $('#dynamic-message').show();
            updateProgress("30%", "Validating token...");
            const token = $('#token-input').val();
            dx.login(token, (err, res) => {

                if (err) {
                    failProgress("Could not login with token!");
                    return;
                } else {
                    updateProgress("100%", "Success!");
                    setTimeout(remote.getCurrentWindow().refreshState(), 1500);
                    return;
                }
            });
        });

        // Don't submit on pressing enter in the text box.
        $('#token-input').keypress( function (event) {
            if (event.keyCode == 13) {
                event.preventDefault();
            }
        });

        // Token's will at least be 10 characters, this needs
        // to be hardened.
        $("#token-input").on('input', () => {
            const val = $('#token-input').val();
            if (val.length < 10) {
                $('#login-btn').addClass("disabled");
            } else {
                $('#login-btn').removeClass("disabled");
            }
        });
    });

</script>

</html>
